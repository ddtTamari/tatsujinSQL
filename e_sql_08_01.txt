
テキスト：達人に学ぶSQL徹底指南書 ～初級者で終わりたくないあなたへ～
日付：4月4日
作成者：玉利

問題番号：演習問題8-①:配列テーブル -------行持ちの場合
内容：
「列に対する量化：オール１の行を探せ」では、疑似配列テーブルで列方向の量化を行う方法を考えました。演習では、このテーブルをちゃんと行持ちの形式に直したテーブルを使いましょう。[i]列が配列の添え字を表しますから、主キーは(key,i)です。

1つのエンティティにつき10行は必要になるので、ちょっとテーブル全体の表示は省略します。A,B,Cの要素は、先の問題で使ったものと同じです。AはオールNULL、Bはi=1の要素だけで3で、あとはNULL、Cはオール1です。
それでは、このテーブルから「オール１」のエンティティだけを選択してください。答えはC一つだけになります。今度は行方向への全称量化なので、EXISTSを使います。
厳密に考えると、この問題はなかなかトリッキーです。その罠の存在に気づいたら上級者です。
もしEXSITSを使って解けたら、別解も考えてみてください。非常に多彩な別解が存在して、面白いですから。

---回答---
実行文

SELECT DISTINCT  key                 -- オール1のKeyを取り出したいので結果が重複しないよう取り出す
  FROM ArrayTbl2 Tbl1                -- 検索対象のArrayTbl2を指定し後程結合で使うので別名で指定
 WHERE NOT EXISTS                    -- 下記条件に当てはまらないものを取得する
  (SELECT * FROM ArrayTbl2 Tbl2      -- 検索対象のArrayTbl2を指定し自己結合のため別名を指定
    WHERE Tbl1.key = Tbl2.key        -- 一行一行調べたいのでKeyをもとに結合する
      AND (Tbl2.val <> 1             -- Valが1のものを取り出したいので1以外を除外する
       OR Tbl2.val IS NULL))         -- それだけでは空白の時取り出してしまうのでNULLの行も除外する
      ;                              -- 命令文を終了させる
      
実行結果
 key
-----
 C
