
テキスト：達人に学ぶSQL徹底指南書 ～初級者で終わりたくないあなたへ～
日付：4月27日
作成者：玉利

問題番号：演習問題10-②
内容：
CASE式による特性関数とHAVING句を組み合わせる技術をもう少し練習しておきましょう。ちょっと難易度の高い問題を出します。
サンプルには「EXISTS述語の使い方」でも使った次のようなテスト結果を保存するテーブルを使います。
ひとりの学生につき複数の強化の結果を保存しています。「EXISTS述語の使い方」では、個々から、次の条件を共に満たす学生を選択するクエリを、述語倫理的な発想によって考えました。
１．算数の点数が80点以上
２. 国語の点数が50点以上
結果は、100番と200番の学生になります。400番のように「国語」のデータが存在しない学生は対象外とします。これをHAVING句と特性関数を使って解いてください。

---回答---
実行文

SELECT   student_id                                      -- 問題文条件に当てはまる学生IDを表示させる
  FROM   TestScores                                      -- 学生の点数とIDの載っているテーブルから取得
GROUP BY student_id                                      -- 各生徒ごとに値を比較する
HAVING   2 = SUM(case                                    -- 条件の数と特性関数を使って条件に合っているか求めた合計値が同じなら取得するようにする
         when subject = '算数' AND Score >= 80 THEN 1    -- 算数の点数が80点以上なら条件に当てはまっているので加算する
         when subject = '国語' AND Score >= 50 THEN 1    -- 国語の点数が50点以上なら条件に当てはまっているので加算する
         ELSE 0 END) ;                                   -- そうでなければ条件に当てはまらないので加算しない
         
         
実行結果
 student_id
------------
        100
        200
