
テキスト：達人に学ぶSQL徹底指南書 ～初級者で終わりたくないあなたへ～
日付：3月7日
作成者：玉利

問題番号：演習問題5-①結合が先か、集約が先か？
内容：
「クロス表で入れ子の表側を作る」(P.87)では、集約してDATAビューとMASTERビューの対応を一対一にしてから結合を行いました。
これはこれでわかりやすい方法ですが、パフォーマンスを考慮するならば、中間ビューを二つ作るのは無駄が多い方法です。
そこで、この中間ビューをなるべく減らすように、コードを改良してください。

---回答---
実行文

SELECT                                                        -- 各年齢層、性別における東北と関東の人口の表を表示する
  MASTER.age_class AS age_class,                              -- age_classとして年齢層の値を取得する
  MASTER.sex_cd AS sex_cd,                                    -- sex_cdとして性別別に分けたいので値を取得する
  SUM(CASE WHEN pref_name IN ('青森', '秋田')                 -- 東北の人口を求めたいので青森、秋田の人口の合計を算出する
              THEN population ELSE NULL END) AS pop_tohoku,   -- もし、青森秋田以外なら合計の計算には入れない、出た値をpop_tohokuとする
  SUM(CASE WHEN pref_name IN ('東京', '千葉')                 -- 関東の人口を求めたいので東京、千葉の人口の合計を算出する
              THEN population ELSE NULL END) AS pop_kanto     -- もし、東京千葉以外なら合計の計算には入れない、出た値をpop_kantoとする
FROM                                                          -- 取り出したい情報を持つテーブルを指定する
    (SELECT                                                   -- 各年齢各性別の組み合わせを取得したいのでそのためのサブクエリを取得する
            age_class,                                        -- 年齢階級を取得する
            sex_cd                                            -- 性別コードを取得する
     FROM                                                     -- 二つのテーブルの各値に対して組み合わせを取得するためのテーブルを指定する
            TblAge                                            -- 年齢階級を持っているTblAgeを指定する
     CROSS JOIN                                               -- クロスジョインを使って組み合わせをすべて出す
            TblSex ) MASTER                                   -- 性別コードを持っているTblSexを指定し出た結果のテーブルをMASTERとする
    LEFT OUTER JOIN                                           -- 組み合わせを全部残したいのでLEFT JOINを使用する
            TblPop DATA                                       -- 人口をのデータを持っているテーブルをDATAとして指定する
    ON  MASTER.age_class = DATA.age_class                     -- 結合のためのキーの一つとして各年齢階級コード同士で結合する
    AND  MASTER.sex_cd    = DATA.sex_cd                       -- もう一つのキーの一つとして性別コード同士で結合する
GROUP BY                                                      -- 各年齢階級、性別コードでまとめたいのでGROUP BYで指定する
   MASTER.age_class,                                          -- 年齢階級を持っているMASTERから年齢階級でグルーピングを行う
   MASTER.sex_cd                                              -- 性別コードでもグルーピングを行いたいので性別コードを持っているMASTERの性別コードでグルーピングする
;                                                             -- 命令文を終了させる

実行結果
+-----------+--------+------------+-----------+
| age_class | sex_cd | pop_tohoku | pop_kanto |
+-----------+--------+------------+-----------+
| 1         | f      |       1300 |      2500 |
| 1         | m      |       1100 |      1800 |
| 2         | f      |       NULL |      NULL |
| 2         | m      |       NULL |      NULL |
| 3         | f      |       1800 |      2100 |
| 3         | m      |       1000 |      NULL |
+-----------+--------+------------+-----------+
