
テキスト：達人に学ぶSQL徹底指南書 ～初級者で終わりたくないあなたへ～
日付：3月28日
作成者：玉利

問題番号：演習問題7-②
内容：
「３．差集合で関係除算を表現する」(P.129)で、除算を減算に還元して解く方法を紹介しました。そのクエリを「厳密な除算」をするよう修正してください(「厳密な除算」の定義、覚えていますか？)今度は過不足なくスキルを満たす社員だけを選択するので、結果は神崎氏ひとりになります。

---回答---
実行文

SELECT DISTINCT emp                                  -- 厳密な除算を行った結果同じ人が複数表示されてしまうため重複を避けて社員を取得
  FROM EmpSkills ES1                                 -- 社員のデータを持っているテーブルを指定する
 WHERE NOT EXISTS                                    -- 各社員が持ってるスキルから該当スキルを引いて何も残らなかったものを取得の条件とする
        (SELECT skill FROM Skills                    -- 該当スキルと比べたいのでスキルを取得
          EXCEPT                                     -- 該当スキルと社員のスキルで該当スキルにしかないものを取得したいので差集合をおこなう
         SELECT skill FROM EmpSkills ES2             -- 各社員のスキルを取得し該当スキルと比べる
         WHERE ES1.emp = ES2.emp)                    -- いま調べている社員と取得した各社員でどの値と調べるかを指定する
   AND                                               -- それだけでは相田さんが取得されてしまうので条件を追加
          (SELECT COUNT(*) FROM Skills)              -- 該当のスキルの個数と各社員の個数が一致していれば個数もスキルも一致する結果になるのでスキル数をカウントする
          =                                          -- 上記個数と同じものを取得したいのでイコールでつなぐ
          (SELECT COUNT(skill) FROM EmpSkills ES2    -- 各社員のスキルの数をカウントし該当スキルの個数と見比べる
           WHERE ES1.emp = ES2.emp)                  -- 先ほどと同じく今調べている社員を指定する
        ;                                            -- 命令文を終了させる
        
実行結果

 emp
------
 神崎
 
